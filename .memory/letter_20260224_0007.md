# Letter to Myself (Session Handoff)

**Date:** 2026-02-24

## 1. Executive Summary
* **Goal:** Replace password login with magic link auth via Resend, remove sidebar from login page.
* **Current Status:** Committed and pushed (`03bcb45`). Vercel deploying. Magic link flow complete — needs `RESEND_API_KEY` set in Vercel env vars to work in production.

## 2. The "Done" List (Context Anchor)
* Added `EmailProvider` to `src/apps/web/app/api/auth/[...nextauth]/route.ts` with Resend SDK for sending magic link emails
* Created `src/shared/infrastructure/auth/magic-link-adapter.ts` — custom minimal NextAuth adapter (createUser, getUser, getUserByEmail, updateUser, createVerificationToken, useVerificationToken)
* Added `emailVerified DateTime?` to User model and `VerificationToken` model in `prisma/schema.prisma`
* Ran `prisma db push` — schema synced to Neon PostgreSQL
* Replaced login form at `src/app/(auth)/login/page.tsx` — email-only input → "check your inbox" confirmation state with email icon
* Restructured routes using Next.js route groups:
  - `src/app/(app)/` — authenticated pages with sidebar + mobile nav (layout.tsx has nav chrome)
  - `src/app/(auth)/login/` — login page without any nav
  - `src/app/layout.tsx` — root layout now only has fonts, metadata, and Providers wrapper
* Added `nodemailer` to dependencies (required by next-auth EmailProvider internally)
* Added `nodemailer` to `serverExternalPackages` in `next.config.ts`
* Set `RESEND_API_KEY` as GitHub Actions variable (may not propagate to Vercel — see next steps)

## 3. The "Pain" Log (CRITICAL)
* **Tried:** Using NextAuth EmailProvider without nodemailer installed
* **Failed:** Build error — `Module not found: Can't resolve 'nodemailer'` (next-auth/providers/email.js requires it even though we use Resend for actual sending)
* **Workaround:** `npm install nodemailer` — it's a peer dependency NextAuth expects
* **Tried:** `npx tsc --noEmit` after moving files to route groups
* **Failed:** Stale `.next/types/validator.ts` referenced old paths
* **Workaround:** `rm -rf .next` then re-check — stale cache issue only
* **Tried:** Setting Vercel env var via `npx vercel env add`
* **Failed:** Project not linked via Vercel CLI
* **Workaround:** Set via GitHub API as Actions variable — but **user must manually add `RESEND_API_KEY` in Vercel dashboard** for the deployment to use it

## 4. Active Variable State
* `RESEND_API_KEY=re_6ggZ9cWw_CNeKqwLMj3sWhqnaNkfusT2z` — added to local `.env`, needs to be set in Vercel
* `EMAIL_FROM` — optional env var, defaults to `Minitik <onboarding@resend.dev>`. Set to custom domain sender once Resend domain is verified.
* Default `onboarding@resend.dev` sender only delivers to the Resend account owner's email — verify a domain in Resend to send to any email
* `verifyRequest` page configured as `/login?verify=1` in NextAuth pages config

## 5. Immediate Next Steps
1. [ ] Add `RESEND_API_KEY` in Vercel dashboard → Settings → Environment Variables → Production
2. [ ] Verify a custom domain in Resend (resend.com/domains) and set `EMAIL_FROM` env var (e.g., `Minitik <noreply@minitik.app>`)
3. [ ] Test magic link flow end-to-end: enter email → receive email → click link → land on dashboard
4. [ ] Consider adding rate limiting on the magic link send endpoint
5. [ ] The CredentialsProvider is still in the NextAuth config as a fallback — remove if no longer needed
